function getSubject(r=document){let n="";if("lms-ptcd.poly.edu.vn"==window.location.host){const e=r.querySelector("ol>li:nth-of-type(5)>a");return e.textContent.replace("_","-").split("-")[1].split(":").pop().trim().replace("Môn ","")}try{let e=r.querySelector(".breadcrumb>.crumb:nth-of-type(6)");n=e.innerText.trim(),["2d, 3d animation - dựng phim","2d","cơ khí","tự động hoá","thiết kế cơ bản"].includes(n.toLowerCase())&&(e=r.querySelector(".breadcrumb>.crumb:nth-of-type(7)"),n=e.innerText.trim());let t=e.innerText.replace(/_/g,"-").split("-");return 1<t.length?(n=t[0].toLowerCase().includes("các lớp")?t[2]:t[1].split(":").pop(),n.includes("Chuyên đề")?n=n.split("Chuyên đề")[1].split(".").pop():n.includes(".")&&(n=n.split(".").pop())):n=t[0],n?n.replace("Môn ","").trim():""}catch(e){return console.debug(e),""}}async function getQuesId(e){try{response=await fetch(e,{method:"GET",redirect:"error"}),htmlData=await response.text();const t=parseHTML(htmlData);return Array.from(t.querySelectorAll("tbody > tr a")).map(e=>e.getAttribute("href"))}catch(e){return console.debug(`getQuesId error: ${e}`),[]}}async function getQA(e,t){console.debug("getQA "+t);var r;let n="";t=`${server}/${t}`;const o=await fetch(t,{method:"GET",redirect:"error"});t=await o.text();const l=parseHTML(t);let c=l.querySelector(".ilc_question_Standard:nth-of-type(4) > div > .answer-table");if(!c)throw new Error(`tableAnswer null - ${e}`);(r=getQues(l))&&"Câu hỏi"==r||"Question"==r?sendHtml("ques = Câu hỏi | Question",t):r||sendHtml(`ques null - ${r} ${e}`,t);try{c=l.querySelector(".ilc_question_Standard:nth-of-type(4) > div > .answer-table"),ansChecked=[...c.querySelectorAll("img[title=Checked]")].map(e=>{var t=e.parentNode.nextElementSibling.querySelector("img");return t?t.outerHTML:e.parentNode.nextElementSibling.textContent.trim()}),n=1==ansChecked.length?ansChecked[0]:ansChecked}catch(e){throw new Error(`getQA error: ${e}`)}if(!n)throw new Error(`ans null - ${e}`);return console.debug("getQA done"),{ques:r,ans:n}}function getQues(e=document){try{var t=e.querySelector(".ilc_qtitle_Title img");return capitalizeFirstLetter(`${e.querySelector(".ilc_qtitle_Title").innerText.trim()}${t?`\n${t.outerHTML}`:""}`).replace(/[^\S\r\n]{2,}/g," ").replace(/\n /g,"\n").replace(/' , '/g,", ").replace(/' . '/g,". ")}catch(e){return""}}async function addQuiz(e,t){if(!e)return console.debug("subjectName null");chrome.runtime.sendMessage({type:"add_quiz",data:{subjectName:e,quizzes:t}})}function getQuizId(){return urlParsed.searchParams.get("ref_id")}function parseHTML(e){return(new DOMParser).parseFromString(e,"text/html")}function capitalizeFirstLetter(e){return e.charAt(0).toUpperCase()+e.slice(1)}async function main(){var t;if(document.querySelector(".alert.alert-success")){const r=getSubject();const n=await getQuesId(window.location.origin+"/"+document.querySelector(".ilTableOuter table > tbody > tr:last-child > td:last-child > a").getAttribute("href"));let e=[];n&&n.length&&(t=n.map(e=>getQA(r,e)),e=await Promise.all(t).catch(e=>{console.error(e)})),console.log(e),addQuiz(r,e)}}main();